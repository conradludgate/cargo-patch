# cargo-patch

`Cargo-Patch` is a Cargo Subcommand which allows
patching dependencies using patch files.

## Installation

Simply run:

```sh
cargo install cargo-patch
```

This is not necessary when patching via `build.rs` file

## Usage

To patch a dependency one has to add the following
to `Cargo.toml`:

```toml
[package.metadata.patch.serde]
version = "1.0"
patches = [
    "test.patch"
]
```

It specifies which dependency to patch (in this case
serde) and one or more patchfiles to apply. Running:

```sh
cargo patch
```

will download the serde package specified in the
dependency section to the `target/patch` folder
and apply the given patches. To use the patched
version one has to override the dependency using
`replace` like this

```toml
[patch.crates-io]
serde = { path = './target/patch/serde-1.0.110' }
```

Instead of running `cargo patch` its also possible to add a `build.rs` file like this:

```rust
fn main() {
    println!("cargo:rerun-if-changed=Cargo.toml");
    println!("cargo:rerun-if-changed=patches/");
    cargo_patch::patch().expect("Failed while patching");
}
```

To make it work, add the cargo-patch library to the `build-dependencies`

```tomlusing the
[build-dependencies]
cargo-patch = "0.3"
```

Note, however, that all your patches should be in a single folder called `patches` or something similar. This is to make sure that the build script is executed again when something changes.

## Developing patches

The `edit`, `diff`, and `save` subcommands provide a git-based workflow for creating and maintaining patches.

### Creating patches

```sh
# Opens a subshell in the patch directory with git branches set up
cargo patch edit serde

# Inside the subshell: edit files, commit changes
git add -A && git commit -m "my-change"
exit

# Preview the diff from upstream
cargo patch diff serde

# Extract commits as .patch files and update Cargo.toml
cargo patch save serde
```

`edit` creates a git repo in `target/patch/<name>-<version>/` and drops you
into a subshell there. The repo has two branches:
- **`upstream`**: tracks upstream release(s)
- **`patched`**: forked from the base version, one commit per patch file

### Upgrading to a newer version

Use `--target` to download all intermediate versions onto the `upstream` branch, then rebase your patches forward:

```sh
# Drops into a subshell; rebase instructions are printed
cargo patch edit serde --target 1.0.200

# Inside the subshell:
git rebase --onto v1.0.200 v1.0.110 patched
# resolve any conflicts, then exit the shell
exit

cargo patch save serde
# then update version and path in Cargo.toml
```

## Patch format

You can either use [diff](http://man7.org/linux/man-pages/man1/diff.1.html) or
[git](https://linux.die.net/man/1/git) to create patch files. Important is that
file paths are relative and inside the dependency.

#### Using diff file generated by GitHub pull request

```toml
[package.metadata.patch.serde]
version = "1.0"
patches = [
    { path = "generatedByGithub.patch", source = "GithubPrDiff" },
    { path = "generatedByGithub2.patch", source = "GithubPrDiff" },
    "test.patch",
    "test2.patch"
]
```

## Limitations

It's only possible to patch dependencies of binary crates as it is not possible
for a subcommand to intercept the build process.
